<svelte:window bind:scrollY={ windowScrollY }
               onkeydown={ onKeyDown } />

<MainTransitionOverlay bind:this={ mainTransitionOverlay } />

<nav id="language-switcher"
     class="fixed font-mono top-0 right-0 z-10 p-4">
  <ul class="flex flex-ro gap-4">
    {#each $locales as loc}
      <li class:current={ loc == $locale }>
        <a href={ `#lang-${loc}` }
           onclick={ event => { event.preventDefault(); changeLanguage(loc); } }>{ loc }</a>
      </li>
    {/each}
  </ul>
</nav>

{#if window && windowScrollY <= 100}
  <div in:fade out:fade
       class="fixed right-0 bottom-0 mx-4 my-2 flex flex-col items-center">
    <div class="font-light text-[1em] capitalize tracking-[0.2em]">SCROLL</div>
    <div bind:this={ scrollDownElement }
         class="font-extralight fill-current w-[1.5em] h-[1.5em] m-[0.5em] mt-[0.25em]">{@html faChevronDown}</div>
  </div>
{/if}

<div id="smooth-wrapper">
  <div id="smooth-content">
    <section id="headline">
      <div class="min-w-full">
        <h1 class="headline-text">
          <p class="font-mono font-light text-nowrap">
            <span class="text-teal-500">web-dev</span>
            <span class="text-pink-500">game-dev</span>
            <span class="text-sky-600">translation</span>
          </p>
          <p bind:this={ headlineElement[0] }>{ $_("main.headline.line1") }</p>
          <p bind:this={ headlineElement[1] }>{ $_("main.headline.line2") }</p>
          <p bind:this={ headlineElement[2] }>{@html $_("main.headline.line3", { values: { emphasize: textToColorHtml($_("main.headline.emphasize")) }})}</p>
          <p class="font-mono font-light text-orange-300 text-[0.25em] text-nowrap my-2">
            <span>{ $_("main.wip") }</span>
          </p>
          <p class="user-typings overflow-clip">
            <span>
              <span>somni &gt;&nbsp;</span><!--
              --><a bind:this={ additionalTypingsUrlAnchor }
                class="user-typings-url"
                href={ additionalTypingsUrl }>
                <!-- Will be filled by typing -->
              </a>
            </span><!--

        --><span class="cursor ml-0.5">â–</span>
            {#if additionalTypingsUrl}
              <span in:fade out:fade
                    class="user-typings-url-hint">Ctrl + â</span>
            {/if}
          </p>
        </h1>
      </div>
    </section>

    <section id="web-dev">
      <h3 class="text-teal-500">web-dev</h3>
      <h2></h2>

      <p class="jujeori">í”Œë«í¼ ë…ë¦½ì ì´ë¼ëŠ” ì ì—ì„œ ë§¤ë ¥ì„ ëŠë¼ê³  ì œ ì£¼ë ¥ ë¶„ì•¼ë¡œ ì •í–ˆìŠµë‹ˆë‹¤.</p>
      <p class="jujeori"><br /></p>
      <p class="jujeori">í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ëª¨ë‘ ê³¨ê³ ë£¨ í•´ë³´ê³  ìˆìŠµë‹ˆë‹¤. <IconText svg={ siTypescript.svg }><b>TypeScript</b></IconText>ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë©°, ì£¼ë ¥ í”„ë¡ íŠ¸ì—”ë“œ í”„ë ˆì„ì›Œí¬ëŠ” <IconText svg={ siVuedotjs.svg }><b>Vue</b></IconText> ë° <IconText svg={ siSvelte.svg }><b>Svelte</b></IconText> ì…ë‹ˆë‹¤. ë°±ì—”ë“œ í”„ë ˆì„ì›Œí¬ë¡œ <IconText svg={ siNestjs.svg }><b>NestJS</b></IconText>ë¥¼ ì‚¬ìš©í•´ ë³¸ ê²½í—˜ì´ ìˆìŠµë‹ˆë‹¤. <IconText svg={ siCss.svg }><b>CSS</b></IconText>ë¥¼ ì§ì ‘ ì‘ì„±í•  ìˆ˜ ìˆìœ¼ë©°, <IconText svg={ siSass.svg }><b>SCSS</b></IconText>ë¥¼ ì„ í˜¸í•©ë‹ˆë‹¤.</p>
    </section>

    <section id="game-dev">
      <h3 class="text-pink-500">game-dev</h3>
      <h2>{ $_("main.section.game-dev.title") }</h2>

      <p class="jujeori">ê²Œì„ì„ ì—´ì‹¬íˆ ì¦ê¸°ê¸°ë§Œ í–ˆì§€ ë§Œë“¤ ìƒê°ì€ í•˜ì§€ ëª»í–ˆë˜ ì €ì—ê²Œ, ì²­ê°•ë¬¸í™”ì‚°ì—…ëŒ€í•™êµ ê²Œì„ì½˜í…ì¸ ìŠ¤ì¿¨ìœ¼ë¡œì˜ ì§„í•™ì€ ë˜ í•˜ë‚˜ì˜ ê°ˆë¦¼ê¸¸ì„ ì•Œë ¤ì£¼ì—ˆìŠµë‹ˆë‹¤.</p>
      <p class="jujeori">ëŒ€í•™êµì—ì„œ '1ì¸ë¶„ì˜ ê²Œì„ í”„ë¡œê·¸ë˜ë¨¸'ê°€ ë˜ê³ ì í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ í•™êµ ìƒí™œì— ì„í•´ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ì–´ì©Œë©´ ê·¸ë¦¬ í° ëª©í‘œì²˜ëŸ¼ ë³´ì´ì§„ ì•Šì„ ìˆ˜ ìˆì§€ë§Œ, ì‹œì‘ì´ ëŠ¦ì€ ì €ì—ê²Œ ìˆì–´ ê·¸ ì‘ì€ ëª©í‘œê°€ ì˜ë¯¸í•˜ëŠ” ë°”ëŠ” ë§¤ìš° í½ë‹ˆë‹¤.</p>
      <p class="jujeori">í˜„ì¬ ì‹¤ë ¥íŒŒ íŒ€ì›ë“¤ê³¼ í•¨ê»˜ "ë‚´ ì†ìœ¼ë¡œ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚´ì•„ ì›€ì§ì´ê²Œ ë§Œë“ ë‹¤"ëŠ” ì„±ì·¨ê° ì†ì—ì„œ ì¡¸ì—… í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
      <p class="jujeori"><br /></p>
      <p class="jujeori">ì €ëŠ” <IconText svg={ siUnity.svg }><b>Unity</b></IconText>ë¥¼ ì£¼ë ¥ìœ¼ë¡œ ë‹¤ë£¨ê³  ìˆìŠµë‹ˆë‹¤. ê²Œì„ì— ì ìš©ë˜ëŠ” <b>ì ì‘í˜• ì‚¬ìš´ë“œ</b>ì—ë„ ê´€ì‹¬ì´ ë§ìœ¼ë©°, ì‚¬ìš´ë“œ ë¯¸ë“¤ì›¨ì–´ë¡œëŠ” <IconText svg={ siFmod.svg }><b>FMOD</b></IconText>ë¥¼ ì£¼ë ¥ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
    </section>

    <section id="translation">
      <h3 class="text-sky-600">translation</h3>
      <h2>{ $_("main.section.translation.title") }</h2>

      <p class="jujeori">ì €ëŠ” í”„ë¡œê·¸ë˜ë°ì„ ë¹¨ë¦¬ ì ‘í–ˆë˜ ë§Œí¼ ì¸í„°ë„· ê²€ìƒ‰ì„ ì˜ì–´ë¡œ í•˜ê³  ì˜ì–´ë¡œ ì“°ì¸ ê¸€ì„ ì½ëŠ” ë“± ì˜ì–´ì— ë¹¨ë¦¬ ìµìˆ™í•´ì¡ŒìŠµë‹ˆë‹¤.</p>
      <p class="jujeori">ì–¸ì  ê°€ ìì£¼ ì“°ëŠ” í”„ë¡œê·¸ë¨ì—ì„œ ë²ˆì—­ ê¸°ì—¬ë¡œ ê°œë°œìì™€ ì‚¬ìš©ìë¥¼ ë„ìš¸ ìˆ˜ ìˆë‹¤ëŠ” ì•ˆë‚´ë¥¼ ë³´ì•˜ê³ , ë‚¨ì„ ë„ìš¸ ìˆ˜ ìˆë‹¤ëŠ” ìƒê°ì— ë¶€ì¡±í•œ ì˜ì–´ ì‹¤ë ¥ì¼ì§€ë¼ë„ ë²ˆì—­ ê¸°ì—¬ë¥¼ ì‹œì‘í–ˆê³ , ì§€ê¸ˆê¹Œì§€ë„ ê°„ê°„ì´ ê¸°ì—¬ë¥¼ í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
      <p class="jujeori"><br /></p>
      <p class="jujeori">ì£¼ë¡œ <b>ì˜ì–´ â†’ í•œêµ­ì–´</b> ë²ˆì—­ ê¸°ì—¬ë¥¼ í•´ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ê°„ë‹¨í•œ ë‹¨ì–´ë‚˜ ë¬¸ì¥ì€ <b>ì˜ì–´, í•œêµ­ì–´ â†’ ì¼ë³¸ì–´</b> ë²ˆì—­ë„ í•©ë‹ˆë‹¤. <b>ì¼ë³¸ì–´ â†’ í•œêµ­ì–´</b> ë²ˆì—­ ê¸°ì—¬ ì‚¬ë¡€ëŠ” ì—†ì—ˆì§€ë§Œ, í•´ë³¼ ê¸°íšŒë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</p>
      <p class="jujeori">ì§ì ‘ ì‚¬ìš©í•˜ëŠ” í”„ë¡œê·¸ë¨ì´ë‚˜ ì„œë¹„ìŠ¤ë¥¼ ëŒ€ìƒìœ¼ë¡œ ë²ˆì—­ ê¸°ì—¬ë¥¼ í•©ë‹ˆë‹¤. ê·¸ëŸ¬í•œ ëŒ€ìƒì˜ íŠ¹ì„± ìƒ, ì‚¬ìš©ìì˜ ê´€ì ì—ì„œ ì´í•´ê°€ ì‰½ë„ë¡ ì–´ëŠ ì •ë„ ì˜ì—­ì„ í¬í•¨í•˜ë©° ë²ˆì—­í•˜ëŠ” í¸ì…ë‹ˆë‹¤.</p>
    </section>

    <section id="trivia">
      <h3 class="text-lime-600">trivia</h3>
      <h2>{ $_("main.section.trivia.title") }</h2>

      <p class="jujeori">ì–´ë ¸ì„ ë•Œ ìš°ì—°í•œ ê³„ê¸°ë¡œ <b>í”¼ì•„ë…¸</b>ë¥¼ ë°°ì› ê³ , í”¼ì•„ë…¸ë¼ëŠ” ì•…ê¸°ì— ë§¤ë£Œë˜ì–´ ì§€ê¸ˆê¹Œì§€ë„ ì´ë”°ê¸ˆì”© ì¢‹ì•„í•˜ëŠ” ê³¡ì„ ì—°ìŠµí•©ë‹ˆë‹¤. ì‚¬ìš©í•˜ëŠ” ë””ì§€í„¸ í”¼ì•„ë…¸ëŠ” <b>ì»¤ì¦ˆì™€ì¼ Ka E1</b>ì…ë‹ˆë‹¤.</p>
      <p class="jujeori"><b>ì„œë¸Œì»¬ì²˜</b>ë¥¼ ì¢‹ì•„í•©ë‹ˆë‹¤. ì²« ì„œë¸Œì»¬ì²˜ ì…ë¬¸ì€ <b>í•˜ì¸ ë„¤ ë¯¸ì¿ </b>ì˜€ê³ , ë™ì‹œì— ì‘ê³¡ì— ëŒ€í•œ ê¿ˆë„ ê°€ì¡ŒìŠµë‹ˆë‹¤. <s>ì‘ê³¡ì´ í˜¸ë½í˜¸ë½í•œ ë¶„ì•¼ê°€ ì•„ë‹Œ ê±¸ ëŠë‚€ í›„ë¡œëŠ” ê¿ˆë§Œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.</s> ì¢‹ì•„í•˜ëŠ” ë¯¸ì¿  ê³¡ì€ <b>livetune - Hand in Hand</b>, <b>DECO*27, kemu - SEKAI</b> ì…ë‹ˆë‹¤.</p>
      <p class="jujeori"><b>ì„œë¸Œì»¬ì²˜ ëª¨ë°”ì¼ ê²Œì„</b>ë„ ì—¬ëŸ¿ í•´ë³´ì•˜ê³ , ì´ëŸ° ê²Œì„ì˜ ìŠ¤íƒ­ ë¡¤ì— ì œ ì´ë¦„ì´ ë“¤ì–´ê°€ëŠ” ê²Œ ëª©í‘œì…ë‹ˆë‹¤. í˜„ì¬ ìµœì• ëŠ” <a href="https://bluearchive.nexon.com/" target="_blank">ë¸”ë£¨ ì•„ì¹´ì´ë¸Œ</a>ì˜ <b>í”„ë¼ë‚˜</b>ì…ë‹ˆë‹¤.</p>
      <p class="jujeori">PCë¡œëŠ” ì£¼ë¡œ ì‹±ê¸€ í”Œë ˆì´ì–´ ìœ„ì£¼ì˜ ê²Œì„ì„ í•©ë‹ˆë‹¤. ì œ ê°œì¸ Top 3ëŠ” <b>Red Dead Redemption 2</b>, <b>Oxygen Not Included</b>, <b>Ori ì‹œë¦¬ì¦ˆ</b>ì…ë‹ˆë‹¤.</p>
      <p class="jujeori"><br /></p>
      <p class="jujeori">í˜„ì‹¤ê³¼ ì¸í„°ë„· ì–´ë”˜ê°€ì—ì„œ ì´ëŸ¬í•œ ì·¨ë¯¸ë“¤ì„ ì—´ì‹¬íˆ í–¥ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
    </section>

    <section id="links">
      <h3 class="text-amber-600">links</h3>

      {#each data.linkData as category}
        <div class="link-category">
          <div class="link-category-title">â— { $_(category.nameTextId) }</div>

          <ul>
            {#each category.links as link}
              <li class="link">
                <a href={ link.url }>{ $_(link.nameTextId) } ({ link.accountDisplayId })</a>
              </li>
            {/each}
          </ul>
        </div>
      {/each}
    </section>
  </div>
</div>

<script lang="ts">
import gsap from "gsap";
import { onMount } from "svelte";
import { _, locale, locales, waitLocale } from "svelte-i18n";
import { fade } from "svelte/transition";
import stringToColor from "string-to-color";
import MainTransitionOverlay from "$/components/animation/MainTransitionOverlay.svelte";
import { ScrollSmoother } from "gsap/ScrollSmoother";
import { siCss, siFmod, siNestjs, siSass, siSvelte, siTypescript, siUnity, siVuedotjs } from "simple-icons";
import IconText from "$/components/common/IconText.svelte";
import faChevronDown from "$/assets/icons/ui/fa-chevron-down.svg?raw";
import type { PageProps } from "./$types";

const typingUrlMap: Record<string, string> = {
  "mail": "mailto:" + atob("bWU=") + "@" + atob("c29tbmkub25l"),
  "email": "mailto:" + atob("bWU=") + "@" + atob("c29tbmkub25l"),

  "twitter": "https://twitter.com/somni_somni",
  "x": "https://twitter.com/somni_somni",

  "bluesky": "https://bsky.app/profile/somni.one",
  "bsky": "https://bsky.app/profile/somni.one",

  "github": "https://github.com/somnisomni",
  "git": "https://github.com/somnisomni",

  "blog": "https://log.somni.one",
  "log": "https://log.somni.one",

  "portfolio": "/works",
  "project": "/works",
  "projects": "/works",
  "work": "/works",
  "works": "/works",
  "resume": "/works",
  "cv": "/works",
};

const typingActionMap: Record<string, () => void> = {
  "english": () => changeLanguage("en"),
  "en": () => changeLanguage("en"),
  "eng": () => changeLanguage("en"),

  "korean": () => changeLanguage("ko"),
  "ko": () => changeLanguage("ko"),
  "kor": () => changeLanguage("ko"),
  "hangul": () => changeLanguage("ko"),
  "hangeul": () => changeLanguage("ko"),

  "japanese": () => changeLanguage("ja"),
  "ja": () => changeLanguage("ja"),
  "jpn": () => changeLanguage("ja"),

  "arona": () => alert("NO PINK ENVELOPES"),
  "plana": () => alert("Love"),
  "koharu": () => alert("ECCHINA NO WA DAME! SHIKEI!"),
  "seia": () => alert("ğŸ”‡"),
};

function changeLanguage(lang: string) {
  if(lang === $locale) {
    return;
  }

  animateText(async () => {
    await locale.set(lang);
    await waitLocale();
  });
}

let mainTransitionOverlay: MainTransitionOverlay | null = $state(null);
let headlineElement: HTMLElement[] = $state([]);
let scrollDownElement: HTMLElement | null = $state(null);

let additionalTypings: string = $state("");
let additionalTypingsSpans: HTMLElement[] = $state([]);
let additionalTypingsUrl: string = $derived(
  additionalTypings.toLowerCase() in typingUrlMap
    ? typingUrlMap[additionalTypings.toLowerCase()]
    : additionalTypings.toLowerCase() in typingActionMap
      ? "#"
      : "");
let additionalTypingsUrlAnchor: HTMLAnchorElement | null = null;

let windowScrollY: number = $state(0);

const { data }: PageProps = $props();

onMount(() => {
  animateText(null, true);

  ScrollSmoother.create({
    smooth: 0.5,
    smoothTouch: 0,
    effects: true,
    autoResize: true,
  });
});

$effect(() => {
  if(scrollDownElement) {
    gsap.to(scrollDownElement, {
      yPercent: 20,
      yoyo: true,
      repeat: -1,
      duration: 2,
      ease: "sine.inOut",
    });
  }
});

function onKeyDown(event: KeyboardEvent) {
  if(event.key.match(/^[a-zA-Z0-9`!@#$%^&*,.;:'"(){}\[\]/\\\-=_+ ]$/)
    && additionalTypings.length <= 20) {
    const newSpan = document.createElement("span");
    newSpan.innerHTML = event.key === " " ? "&nbsp;" : event.key;
    newSpan.style.display = "inline-block";
    additionalTypingsSpans.push(newSpan);
    animateTypeIn(newSpan);

    additionalTypings += event.key;
  } else if(event.key === "Backspace") {
    additionalTypingsSpans.pop();

    additionalTypings = additionalTypings.slice(0, -1);
  } else if(event.key === "Enter" && event.ctrlKey) {
    if(additionalTypings.toLowerCase() in typingActionMap) {
      typingActionMap[additionalTypings.toLowerCase()]();
      additionalTypingsSpans = [];

      additionalTypings = "";
    } else if(additionalTypingsUrlAnchor) {
      additionalTypingsUrlAnchor.click();
    }
  } else if(event.key === "Escape") {
    additionalTypingsSpans = [];
    additionalTypings = "";
  }

  if(additionalTypingsUrlAnchor) {
    additionalTypingsUrlAnchor.replaceChildren(...additionalTypingsSpans);
  }
}

function animateTypeIn(targetElement: HTMLElement) {
  gsap.set(targetElement, {
    yPercent: 10,
    opacity: 0,
  });
  gsap.to(targetElement, {
    yPercent: 0,
    opacity: 1,
    duration: 0.25,
    ease: "power2.out",
  });
}

async function animateText(onCover: (() => void | Promise<void>) | null = null, firstLoad = false) {
  if(!mainTransitionOverlay) {
    return;
  }

  const outTimeline = gsap.timeline({ paused: true });
  const inTimeline = gsap.timeline({ paused: true });

  // Out timeline setup
  {
    if(!firstLoad) {
      outTimeline.add(mainTransitionOverlay.slideIn());

      outTimeline.to(headlineElement, {
        opacity: 0,
        xPercent: 10,
        stagger: 0.1,
        ease: "power2.in",
      }, "<");

      for(const h2 of document.querySelectorAll("section > h2")) {
        outTimeline.to(h2, {
          opacity: 0,
          xPercent: 5,
          ease: "power2.in",
        }, "<");
      }
    } else {
      outTimeline.set(headlineElement, {
        opacity: 0,
        xPercent: -10,
      });

      for(const h2 of document.querySelectorAll("section > h2")) {
        outTimeline.set(h2, {
          opacity: 0,
          xPercent: 5,
        });
      }
    }
  }

  // In timeline setup
  {
    if(!firstLoad) {
      inTimeline.add(mainTransitionOverlay.slideOut());
    }

    outTimeline.set(headlineElement, {
      opacity: 0,
      xPercent: -10,
    });

    inTimeline.to(headlineElement, {
        opacity: 1,
        xPercent: 0,
        stagger: 0.1,
        ease: "power2.out",
      }, "<");
  }

  // Actual animation
  outTimeline.play();
  await outTimeline.then();
  await onCover?.();
  inTimeline.play();

  // Set up scroll trigger animations
  for(const h2 of document.querySelectorAll("section > h2")) {
    gsap.set(h2, {
      opacity: 0,
      xPercent: -5,
    });

    gsap.to(h2, {
      scrollTrigger: h2,
      opacity: 1,
      xPercent: 0,
      ease: "power2.out",
    });
  }
}

function textToColorHtml(text: string) {
  const color = stringToColor(`darken ${text}`);
  return `<span style="color: ${color}">${text}</span>`;
}
</script>

<style scoped>
@reference "$/styles/app.css";

nav#language-switcher .current {
  @apply underline;
}

section {
  @apply flex flex-col min-h-screen items-start justify-start;
  @apply p-4
         sm:p-8
         lg:p-12
         xl:p-16;
  @apply mb-8
         lg:mb-16;
  @apply w-full
         xl:w-[75%];
}

section#headline {
  @apply items-start justify-center;
}

section#headline .headline-text {
  @apply flex flex-col font-[550];
  @apply text-[3rem]
         sm:text-[4rem]
         lg:text-[6rem]
         xl:text-[7rem];

  line-height: 1.33;
}

section#headline .headline-text > :first-child,
section#headline .headline-text > :last-child {
  @apply text-zinc-400;

  font-size: 0.33em;
  line-height: 3;
}

:global(section#headline .headline-text strong) {
  @apply font-black;
}

section#headline .user-typings {
  @apply flex items-center break-all font-mono;
}

section#headline a.user-typings-url[href=""] {
  @apply pointer-events-none;
}

section#headline a.user-typings-url:not([href=""]),
:global(section#headline a.user-typings-url:not([href=""]) > *) {
  @apply underline;
}

section#headline .user-typings-url-hint {
  @apply font-sans font-light text-[0.4em] p-[0.6em] shadow-md rounded-full;

  line-height: 1;
}

section#headline .cursor {
  @apply pointer-events-none select-none;

  animation: fadeInOut 1.5s cubic-bezier(0.5, 0, 0.5, 1) infinite;
}

section h2 {
  @apply font-extrabold my-8;
  @apply text-[2.5rem]
         sm:text-[3.5rem];

  line-height: 1.2;
}

section h3 {
  @apply font-mono font-light text-nowrap lowercase;
  @apply text-[1rem]
         sm:text-[1.5rem];
}

section h3::before {
  content: "> ";
}

section .jujeori {
  @apply font-light text-zinc-400 indent-2;
  @apply text-[1.2rem]
         sm:text-[1.33rem]
         md:text-[1.5rem];

  line-height: 2;
}

section .jujeori b {
  @apply font-bold;
}

section .jujeori s {
  @apply text-zinc-300;
}

section .jujeori a {
  @apply underline;
}
</style>
